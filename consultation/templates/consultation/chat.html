{% extends 'base.html' %}
{% block title %}Chat dengan Dokter{% endblock %}
{% block content %}
<div class="mb-4">
    <a href="{% url 'consultation:consultation_dashboard' %}" class="text-decoration-none">&larr; Kembali ke daftar dokter</a>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start">
        <div>
            <h4 class="mb-1">Dr. {{ doctor.user.get_full_name|default:doctor.user.username }}</h4>
            <p class="mb-0 text-muted">
                {{ doctor.specialization }}
                {% if doctor.poliklinik %}
                    &middot; {{ doctor.poliklinik.name }}
                {% endif %}
            </p>
            <small class="text-muted">Kontak: {{ doctor.email }} | {{ doctor.phone|default:"-" }}</small>
        </div>
        <div class="mt-3 mt-md-0">
            {% if consultation.status == 'Berlangsung' %}
                <span class="badge bg-info text-dark">Sedang berlangsung</span>
            {% elif consultation.status == 'Menunggu' %}
                <span class="badge bg-warning text-dark">Menunggu</span>
            {% else %}
                <span class="badge bg-success">Selesai</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="chat-window mb-4" style="max-height: 400px; overflow-y: auto;">
            {% if messages %}
                {% for msg in messages %}
                    <div class="mb-3 {% if msg.sender == 'patient' %}text-end{% endif %}">
                        <div class="d-inline-block px-3 py-2 rounded-3 {% if msg.sender == 'patient' %}bg-success text-white{% elif msg.sender == 'bot' %}bg-light border{% else %}bg-primary text-white{% endif %}">
                            <small class="d-block fw-semibold mb-1">
                                {% if msg.sender == 'patient' %}
                                    Kamu
                                {% elif msg.sender == 'bot' %}
                                    Chatbot SehatKuy
                                {% else %}
                                    Dokter
                                {% endif %}
                            </small>
                            <div>{{ msg.message|linebreaks }}</div>
                            <small class="d-block text-end mt-1 {% if msg.sender == 'patient' %}text-white-50{% else %}text-muted{% endif %}">
                                {{ msg.created_at|date:"d M Y, H:i" }}
                            </small>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-muted text-center mb-0">Belum ada pesan. Mulai percakapan dengan menulis keluhan pertama kamu.</p>
            {% endif %}
        </div>

        <form method="POST">
            {% csrf_token %}
            {{ form.non_field_errors }}
            <div class="mb-3">
                {{ form.message }}
            </div>
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-success">Kirim Pesan</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

