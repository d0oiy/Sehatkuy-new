{% extends 'adminpanel/base.html' %}
{% load static %}
{% load currency_filters %}
{% block content %}

<div class="row g-3 mb-4">
  <div class="col-md-3"><div class="card p-3">Total Users<br><strong>{{ total_users }}</strong></div></div>
  <div class="col-md-3"><div class="card p-3">Total Dokter<br><strong>{{ total_doctors }}</strong></div></div>
  <div class="col-md-3"><div class="card p-3">Konsultasi<br><strong>{{ total_consultations }}</strong></div></div>
</div>

<<<<<<< HEAD
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #f4f6f9;
      font-family: 'Inter', sans-serif;
    }

    .navbar {
      background: linear-gradient(90deg, #007bff, #00b4d8);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    .navbar-brand {
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .card {
      border: none;
      border-radius: 12px;
      transition: all 0.25s ease-in-out;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }

    .chart-container {
      position: relative;
      height: 420px;
      margin-top: 2rem;
      background-color: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }

    .btn-dashboard {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 500;
    }

    .activity-list li {
      background-color: #fff;
      border-left: 5px solid #0d6efd;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .form-control, .form-control:focus {
      border-radius: 0.25rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .form-group small {
      display: block;
      margin-top: 0.25rem;
      color: #6c757d;
    }

    .medicine-form-card {
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #0d6efd, #0056b3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .medicine-form-header {
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px 12px 0 0;
    }

    .medicine-form-body {
      background: white;
      padding: 1.5rem;
      border-radius: 0 0 12px 12px;
    }

    footer {
      text-align: center;
      color: #888;
      font-size: 0.9rem;
      padding: 20px 0;
      border-top: 1px solid #ddd;
      margin-top: 3rem;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark px-3">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <span class="navbar-brand mb-0 fs-5">Sehatkuy Admin Panel</span>
      <div>
        <a href="{% url 'adminpanel:activity_log' %}" class="btn btn-light btn-sm me-2"><i class="bi bi-gear"></i> Pengaturan</a>
        <a href="{% url 'logout' %}" class="btn btn-outline-light btn-sm"><i class="bi bi-box-arrow-right"></i> Logout</a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-5">
    <h2 class="fw-bold text-center mb-4">Dashboard Statistik Sehatkuy</h2>

    <!-- Tambah Obat Baru Section -->
    <div class="medicine-form-card">
      <div class="medicine-form-header">
        <h4 class="mb-0"><i class="bi bi-plus-circle-fill"></i> Tambah Obat Baru</h4>
      </div>
      <div class="medicine-form-body">
        <form method="post" novalidate>
          {% csrf_token %}
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                {{ form.name }}
                {% if form.name.errors %}
                <div class="text-danger small mt-1">{{ form.name.errors }}</div>
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ form.dosage.id_for_label }}">{{ form.dosage.label }}</label>
                {{ form.dosage }}
                {% if form.dosage.errors %}
                <div class="text-danger small mt-1">{{ form.dosage.errors }}</div>
                {% endif %}
                <small>Contoh: 500mg, 10mL</small>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ form.unit.id_for_label }}">{{ form.unit.label }}</label>
                {{ form.unit }}
                {% if form.unit.errors %}
                <div class="text-danger small mt-1">{{ form.unit.errors }}</div>
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ form.stock.id_for_label }}">{{ form.stock.label }}</label>
                {{ form.stock }}
                {% if form.stock.errors %}
                <div class="text-danger small mt-1">{{ form.stock.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="{{ form.price.id_for_label }}">{{ form.price.label }}</label>
                {{ form.price }}
                {% if form.price.errors %}
                <div class="text-danger small mt-1">{{ form.price.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
            {{ form.description }}
            {% if form.description.errors %}
            <div class="text-danger small mt-1">{{ form.description.errors }}</div>
            {% endif %}
          </div>

          <div class="form-group">
            <label for="{{ form.side_effects.id_for_label }}">{{ form.side_effects.label }}</label>
            {{ form.side_effects }}
            {% if form.side_effects.errors %}
            <div class="text-danger small mt-1">{{ form.side_effects.errors }}</div>
            {% endif %}
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="bi bi-check-circle-fill"></i> Simpan
            </button>
            <a href="{% url 'pharmacy:medicine_list' %}" class="btn btn-secondary btn-lg">
              <i class="bi bi-x-circle-fill"></i> Batal
            </a>
          </div>
        </form>
      </div>
    </div>

    <!-- Statistik Cards -->
    <div class="row g-4 text-center">
      <div class="col-md-2 col-6">
        <div class="card p-3 shadow-sm">
          <h6 class="text-muted">Total Pengguna</h6>
          <h3 class="fw-bold text-primary">{{ total_users|default:0 }}</h3>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="card p-3 shadow-sm">
          <h6 class="text-muted">Pasien</h6>
          <h3 class="fw-bold text-success">{{ total_patients|default:0 }}</h3>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="card p-3 shadow-sm">
          <h6 class="text-muted">Dokter</h6>
          <h3 class="fw-bold text-info">{{ total_doctors|default:0 }}</h3>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="card p-3 shadow-sm">
          <h6 class="text-muted">Konsultasi</h6>
          <h3 class="fw-bold text-warning">{{ total_consultations|default:0 }}</h3>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="card p-3 shadow-sm">
          <h6 class="text-muted">Artikel</h6>
          <h3 class="fw-bold text-danger">{{ total_articles|default:0 }}</h3>
          <small class="text-muted">{{ published_articles|default:0 }} diterbitkan</small>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="card p-3 shadow-sm">
          <h6 class="text-muted">Aktivitas</h6>
          <h3 class="fw-bold text-secondary">{{ activities|length|default:0 }}</h3>
        </div>
      </div>
    </div>

    <!-- Grafik Data -->
    <div class="chart-container">
      <canvas id="dataChart"></canvas>
    </div>

    <!-- zn Pasien & Konsultasi -->
    <div class="row mt-5">
      <!-- Konsultasi Terbaru -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">Konsultasi Terbaru</h5>
          </div>
          <div class="card-body">
            {% if recent_consultations %}
              <ul class="list-group">
                {% for c in recent_consultations %}
                  <li class="list-group-item">
                    <strong>{{ c.patient.username }}</strong> â€” {{ c.complaint|truncatechars:60 }}
                    <div class="text-muted small">{{ c.date|date:"d M Y" }}</div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">Belum ada konsultasi.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Pesanan Obat Terbaru -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">Pesanan Obat Terbaru</h5>
          </div>
          <div class="card-body">
            {% if recent_orders %}
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>No. Pesanan</th>
                    <th>Pasien</th>
                    <th>Obat</th>
                    <th>Tanggal</th>
                    <th>Status</th>
                    <th>Total</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  {% for o in recent_orders %}
                  <tr>
                    <td><strong>{{ o.order_number }}</strong></td>
                    <td>{{ o.patient.username }}</td>
                    <td>
                      {% if o.items.all %}
                        {% for item in o.items.all|slice:":2" %}
                          <small>{{ item.medicine.name }} {% if item.medicine.dosage %}({{ item.medicine.dosage }}){% endif %} â€” Jumlah: {{ item.quantity }}</small><br>
                        {% endfor %}
                        {% if o.items.count > 2 %}
                          <small class="text-muted">+{{ o.items.count|add:"-2" }} lainnya</small>
                        {% endif %}
                      {% else %}
                        <small class="text-muted">-</small>
                      {% endif %}
                    </td>
                    <td>{{ o.created_at|date:"d M Y H:i" }}</td>
                    <td>
                      <span class="badge 
                        {% if o.status == 'pending' %}bg-warning
                        {% elif o.status == 'confirmed' %}bg-info
                        {% elif o.status == 'received' %}bg-success
                        {% elif o.status == 'delivered' %}bg-success
                        {% else %}bg-secondary{% endif %}">
                        {{ o.get_status_display }}
                      </span>
                    </td>
                    <td>{{ o.total_price|rupiah }}</td>
                    <td>
                      <a href="{% url 'pharmacy:admin_order_detail' o.pk %}" class="btn btn-sm btn-primary" title="Lihat detail">
                        <i class="bi bi-eye"></i> Lihat
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p class="text-muted text-center">Belum ada pesanan.</p>
            {% endif %}
            <div class="text-center mt-3">
              <a href="{% url 'pharmacy:patient_orders' %}" class="btn btn-success btn-sm">
                <i class="bi bi-list-check"></i> Lihat Semua Pesanan
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Artikel Terbaru -->
    {% if recent_articles %}
    <div class="row mt-5">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-journal-text"></i> Artikel Terbaru</h5>
            <a href="{% url 'articles:admin_list' %}" class="btn btn-light btn-sm">
              <i class="bi bi-arrow-right"></i> Kelola Artikel
            </a>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Judul</th>
                    <th>Penulis</th>
                    <th>Status</th>
                    <th>Views</th>
                    <th>Tanggal</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  {% for article in recent_articles %}
                    <tr>
                      <td><strong>{{ article.title }}</strong></td>
                      <td>{{ article.author.get_full_name|default:article.author.username }}</td>
                      <td>
                        {% if article.is_published %}
                          <span class="badge bg-success">Diterbitkan</span>
                        {% else %}
                          <span class="badge bg-secondary">Draft</span>
                        {% endif %}
                      </td>
                      <td>{{ article.views_count }}</td>
                      <td>{{ article.created_at|date:"d M Y" }}</td>
                      <td>
                        <div class="btn-group">
                          <a href="{% url 'articles:detail' article.slug %}" class="btn btn-sm btn-info" target="_blank">
                            <i class="bi bi-eye"></i> Lihat
                          </a>
                          <a href="{% url 'articles:admin_edit' article.id %}" class="btn btn-sm btn-warning">
                            <i class="bi bi-pencil"></i> Edit
                          </a>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Quick Access -->
    <div class="d-flex flex-wrap gap-3 justify-content-center mt-5">
      <a href="{% url 'adminpanel:user_list' %}" class="btn btn-outline-primary btn-dashboard">
        <i class="bi bi-people-fill"></i> Kelola Pengguna
      </a>
      <a href="{% url 'adminpanel:doctor_list' %}" class="btn btn-outline-success btn-dashboard">
        <i class="bi bi-person-badge-fill"></i> Kelola Dokter
      </a>
      <a href="{% url 'articles:admin_list' %}" class="btn btn-outline-purple btn-dashboard" style="border-color: #6f42c1; color: #6f42c1;">
        <i class="bi bi-journal-text"></i> Kelola Artikel
      </a>
      <a href="{% url 'articles:admin_create' %}" class="btn btn-outline-purple btn-dashboard" style="border-color: #6f42c1; color: #6f42c1; background: linear-gradient(135deg, #6f42c1, #8b5cf6); color: white; border: none;">
        <i class="bi bi-plus-circle"></i> Buat Artikel Baru
      </a>
      <a href="{% url 'pharmacy:medicine_list' %}" class="btn btn-outline-info btn-dashboard">
        <i class="bi bi-capsule"></i> Kelola Obat
      </a>
      <a href="{% url 'pharmacy:patient_orders' %}" class="btn btn-outline-danger btn-dashboard">
        <i class="bi bi-receipt"></i> Lihat Pesanan Pasien
      </a>
      <a href="{% url 'adminpanel:consultation_list' %}" class="btn btn-outline-warning btn-dashboard">
        <i class="bi bi-chat-left-text-fill"></i> Lihat Konsultasi
      </a>
      <a href="{% url 'adminpanel:activity_log' %}" class="btn btn-outline-secondary btn-dashboard">
        <i class="bi bi-gear-fill"></i> Pengaturan Sistem
      </a>
    </div>

    <!-- Aktivitas Terbaru -->
    <div class="mt-5">
      <h4 class="fw-bold mb-3">ðŸ•’ Aktivitas Terbaru</h4>
      <ul class="list-group shadow-sm activity-list">
        {% if activity_logs %}
          {% for log in activity_logs %}
            <li class="list-group-item">{{ log }}</li>
          {% endfor %}
        {% else %}
          <li class="list-group-item text-muted">Belum ada aktivitas terbaru.</li>
        {% endif %}
      </ul>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    Â© 2025 <strong>Sehatkuy</strong> â€” Sistem Informasi Layanan Kesehatan Digital.
  </footer>

  <!-- Chart Script -->
  <script>
    const ctx = document.getElementById('dataChart');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Pasien', 'Dokter', 'Konsultasi', 'Artikel'],
        datasets: [{
          label: 'Jumlah Data',
          data: [
            {{ total_patients|default:"0" }},
            {{ total_doctors|default:"0" }},
            {{ total_consultations|default:"0" }},
            {{ total_articles|default:"0" }}
          ],
          backgroundColor: ['#0d6efd', '#20c997', '#ffc107', '#6f42c1'],
          borderRadius: 8,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: {
            display: true,
            text: 'Statistik Sistem Sehatkuy',
            font: { size: 18, weight: 'bold' }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1, precision: 0 }
          }
        }
      }
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
=======
<h5>Aktivitas Terakhir</h5>
<ul class="list-group">
  {% for a in activity_logs %}
  <li class="list-group-item">{{ a.user.username }} â€” {{ a.action }} <span class="text-muted float-end">{{ a.timestamp|date:"d M Y H:i" }}</span></li>
  {% empty %}
  <li class="list-group-item text-muted">Belum ada aktivitas.</li>
  {% endfor %}
</ul>
{% endblock %}
>>>>>>> b0efa40 (update konsultasi)
